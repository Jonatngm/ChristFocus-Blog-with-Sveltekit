import{s as g}from"./DzKOTJ0Y.js";class n{async getPublishedPosts(e){let t=g.from("posts").select(`
        *,
        categories:post_categories(category:categories(*)),
        tags:post_tags(tag:tags(*)),
        series(*)
      `).eq("published",!0).order("created_at",{ascending:!1});e!=null&&e.featured&&(t=t.eq("featured",!0)),e!=null&&e.searchQuery&&(t=t.or(`title.ilike.%${e.searchQuery}%,content.ilike.%${e.searchQuery}%,excerpt.ilike.%${e.searchQuery}%`));const{data:r,error:a}=await t;if(a)throw a;const i=(r||[]).map(s=>{var o,c;return{...s,categories:((o=s.categories)==null?void 0:o.map(l=>l.category))||[],tags:((c=s.tags)==null?void 0:c.map(l=>l.tag))||[]}});return e!=null&&e.categorySlug?i.filter(s=>s.categories.some(o=>o.slug===e.categorySlug)):e!=null&&e.tagSlug?i.filter(s=>s.tags.some(o=>o.slug===e.tagSlug)):e!=null&&e.seriesSlug?i.filter(s=>{var o;return((o=s.series)==null?void 0:o.slug)===e.seriesSlug}):i}async getPostById(e){var a,i;const{data:t,error:r}=await g.from("posts").select(`
        *,
        categories:post_categories(category:categories(*)),
        tags:post_tags(tag:tags(*)),
        series(*)
      `).eq("id",e).single();if(r)throw r;return{...t,categories:((a=t.categories)==null?void 0:a.map(s=>s.category))||[],tags:((i=t.tags)==null?void 0:i.map(s=>s.tag))||[]}}async incrementViews(e,t){if(!t)return null;try{const{data:r,error:a}=await g.rpc("increment_unique_view",{p_post_id:e,p_anon_id:t});return a?(console.error("View tracking error:",a.message),null):r||null}catch(r){return console.error("View tracking failed:",r),null}}async getAllPosts(){const{data:e,error:t}=await g.from("posts").select(`
        *,
        categories:post_categories(category:categories(*)),
        tags:post_tags(tag:tags(*)),
        series(*)
      `).order("created_at",{ascending:!1});if(t)throw t;return(e||[]).map(r=>{var a,i;return{...r,categories:((a=r.categories)==null?void 0:a.map(s=>s.category))||[],tags:((i=r.tags)==null?void 0:i.map(s=>s.tag))||[]}})}async createPost(e,t){const{category_ids:r,tag_names:a,...i}=t,s=t.title?t.title.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""):"",{data:o,error:c}=await g.from("posts").insert({author_id:e,slug:s,...i}).select().single();if(c)throw c;return r&&r.length>0&&await this.updatePostCategories(o.id,r),a&&a.length>0&&await this.updatePostTags(o.id,a),o}async updatePost(e,t){const{category_ids:r,tag_names:a,...i}=t,{data:s,error:o}=await g.from("posts").update({...i,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw o;return r!==void 0&&await this.updatePostCategories(e,r),a!==void 0&&await this.updatePostTags(e,a),s}async deletePost(e){const{error:t}=await g.from("posts").delete().eq("id",e);if(t)throw t}async updatePostCategories(e,t){if(await g.from("post_categories").delete().eq("post_id",e),t.length>0){const{error:r}=await g.from("post_categories").insert(t.map(a=>({post_id:e,category_id:a})));if(r)throw r}}async updatePostTags(e,t){if(await g.from("post_tags").delete().eq("post_id",e),t.length===0)return;const r=[];for(const i of t){const s=i.toLowerCase().replace(/\s+/g,"-"),{data:o}=await g.from("tags").select("id").eq("slug",s).single();if(o)r.push(o.id);else{const{data:c,error:l}=await g.from("tags").insert({name:i,slug:s}).select("id").single();if(l)throw l;r.push(c.id)}}const{error:a}=await g.from("post_tags").insert(r.map(i=>({post_id:e,tag_id:i})));if(a)throw a}async uploadImage(e,t){const{data:r,error:a}=await g.storage.from("post-images").upload(t,e,{cacheControl:"3600",upsert:!1});if(a)throw a;const{data:{publicUrl:i}}=g.storage.from("post-images").getPublicUrl(r.path);return i}async getCategories(){const{data:e,error:t}=await g.from("categories").select("*").order("name");if(t)throw t;return e||[]}async createCategory(e,t){const r=e.toLowerCase().replace(/\s+/g,"-"),{data:a,error:i}=await g.from("categories").insert({name:e,slug:r,description:t}).select().single();if(i)throw i;return a}async getTags(){const{data:e,error:t}=await g.from("tags").select("*").order("name");if(t)throw t;return e||[]}async getSeries(e){let t=g.from("series").select("*").order("created_at",{ascending:!1});const{data:r,error:a}=await t;if(a)throw a;return r||[]}async createSeries(e,t,r){const a=t.toLowerCase().replace(/\s+/g,"-"),{data:i,error:s}=await g.from("series").insert({title:t,slug:a,description:r}).select().single();if(s)throw s;return i}async getSeriesBySlug(e){const{data:t,error:r}=await g.from("series").select("*").eq("slug",e).single();if(r)throw r;return t}async getPostsBySeries(e){const{data:t,error:r}=await g.from("posts").select(`
        *,
        categories:post_categories(category:categories(*)),
        tags:post_tags(tag:tags(*)),
        series(*)
      `).eq("series_id",e).eq("published",!0).order("series_order",{ascending:!0});if(r)throw r;return(t||[]).map(a=>{var i,s;return{...a,categories:((i=a.categories)==null?void 0:i.map(o=>o.category))||[],tags:((s=a.tags)==null?void 0:s.map(o=>o.tag))||[]}})}}const f=new n;export{f as p};
